<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width" />
        <!-- firebase initialisation -->
        
        <script src="https://www.gstatic.com/firebasejs/4.8.0/firebase.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script>
          // Initialize Firebase
          var config = {
            apiKey: "AIzaSyButp2-SFrYWWGZEZORCtE5K12WATgyPvc",
            authDomain: "okayestcoder.firebaseapp.com",
            databaseURL: "https://okayestcoder.firebaseio.com",
            projectId: "okayestcoder",
            storageBucket: "okayestcoder.appspot.com",
            messagingSenderId: "935764653668"
          };
          firebase.initializeApp(config);
            var database = firebase.database();
            var dataDump = database.ref('posts').orderByChild('index');
            var string_of_posts = "";
            dataDump.on('value', function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    var childData = childSnapshot.val();
                    // Generate the HTML for #main - all of the posts
                    
                    // Create thumbnail url, create default if it doesn't exist
                    var thumbnail_url = childData['thumbnail'];
                    if (thumbnail_url == null) {
                        thumbnail_url = "testimg.jpg";
                    }
                    
                    var postNum = (childData['index']);
                    if(parseInt(childData['index']) % 2 == 0) { 
                        string_of_posts += '<div class="post" onclick="displayPost(' + postNum + ')">';
                    } 
                    else {
                       string_of_posts += '<div class="post2" onclick="displayPost(' + postNum + ')">';
                    }
                     string_of_posts += '<div class="postContent"><img src="' + thumbnail_url + '" class="thumbnail" align="right" alt="test!" />' +
                            '<h2>' + childData['title'] + '</h2>' +
                            '<h3>' + childData['date'] + '</h3>' ;
                    
                    var blurb = childData['text'].slice(0,250);               
                    // Strip HTML tags so we don't get images in the posts list
                    var blurbStripped = blurb.replace(/<[^>]+>/g, ''); 
                    string_of_posts += blurbStripped + '....<strong> Continue</strong><br />' +
                        '<h5><strong>Tags </strong>';
                    // Display all tags of a post
                    for(var i = 0; i < childData['tags'].length; i++) {
                        string_of_posts += '<mark>&nbsp;' + childData['tags'][i] + '&nbsp;</mark>&nbsp;&nbsp;';
                    }
                    string_of_posts += '</h5></div></div>';
                });
                // Map HTML to #main div content
                var list_of_posts = string_of_posts;
                $('#main').html(list_of_posts);   
            });
        </script>
        <script src="htmlImporter.js"></script>
        
        <title>The Okay-est Coder: Home</title>
        <link rel="stylesheet" type="text/css" href="mainstyle.css">
        
                <!-- Prism Syntax Highlighter 
        To use: enclose code block in :
            <code class="language-*language*"> ** code ** </code>
        -->
        <link href="prism_highlighter/prism.css" rel="stylesheet" type="text/css" />
        <script src="prism_highlighter/prism.js" type="text/javascript"></script>
        
    </head>
    
    <body>
     <script>HTMLImporter.import("menu.html");</script>

        <div id="main">
        <!-- Posts will go here; populated by javascript above -->
        </div>

        
        <script>
        
        // Display Selected Post when displayPost() is called
        function displayPost(postNum) {
            var database = firebase.database();
            var post_string = "";
            var dataDump = database.ref('posts').orderByChild('index');

            dataDump.on('value', function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    var childData = childSnapshot.val();
                    if(childData['index'] == postNum ) {
                        if(postNum % 2 == 0) {
                            post_string += '<div class="post">';
                        }
                        else {
                            post_string += '<div class="post2">';
                        }
                    post_string += '<div class="postContentFull">' +
                    '<h3><a href="index.html">< Return to home</a></h3>' +
                    '<h1>' + childData['title'] + '</h1>' +
                    '<h3>' + childData['date'] + '</h3>' +
                    '<h5><strong>Tags </strong>';
                    // Display all tags
                    for(var i = 0; i < childData['tags'].length; i++) {
                        post_string += '<mark>&nbsp;' + childData['tags'][i] + '&nbsp;</mark>&nbsp;&nbsp;';  
                    }
                    post_string += '</h5>' + childData['text'] + '<br /><br /></div></div>';
                        
                    }                  
                });
            });
            // Set data to #main div
            
            $('#main').html(post_string);
            // Re-render prism highlighting on inserted HTML
            Prism.highlightAll();
        }
        </script>  
    </body>
</html>